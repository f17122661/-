# 学习 mqtt



## onenet平台
``` 说明
1. 产品 ESP8266
2. master-APIkey: DfUYJzRMQG84Zk17u91iRjmVFOA=
3. access_key: 6+nA6nMuD+u/FusUnVuusRWS8yXpyiVhPv6lyfPwQq4=
4. 设备注册码: egKXTmNNdhRBxgdw
5. oneNET MQTT服务器 183.230.40.39:6002



//设备1
设备ID: 572878607
产品ID: 298563

//设备2
设备ID: 572878586
产品ID: 298563

```




## 一. CONNECT – 连接服务端

### 1.1 报文格式
10 23 00 04 4d 51 54 54 04 C0 00 78 00 09 35 37 32 38 37 38 36 30 37 00 06 32 39 38 35 36 33 00 04 30 31 30 32 


``` 消息编码分析

[ 0x10 ]   // MQTT类型=1  DupFlag=0 QosLevel=0 Retain=0 
[ 0x23 ]   // remainedLength=35 

[ 0x00 0x04 ]   // protocolNameLength=4 
[ 0x4D 0x51 0x54 0x54 ]   // protocolName=MQTT 
[ 0x04 ]   // protocolLevel=4 

[ 0xC0 ]   // userFlag=1 passwordFlag=1 willFlag=0 willRetainFlag=0 willQosFlag=0 clenSessionFlag=0 clenSessionFlag=0 
[ 0x00 0x78 ]   // keepAlive=120 

 0x00 0x09 ]   // clientIdentifierLen=9 
[ 0x35 0x37 0x32 0x38 0x37 0x38 0x36 0x30 0x37 ]   // clientIdentifier=572878607 
[ 0x00 0x06 ]   // userNameLen=6 
[ 0x32 0x39 0x38 0x35 0x36 0x33 ]   // userName=298563 
[ 0x00 0x04 ]   // userPasswordLen=4 
[ 0x30 0x31 0x30 0x32 ]   // userPassword=0102 


```

## 二. CONNACK – 确认连接请求

### 2.1 报文格式

0x20 0x02 0x00 0x00

``` 
[ 0x20 ]   // MQTT类型=2  DupFlag=0 QosLevel=0 Retain=0 
[ 0x02 ]   // remainedLength=2 

[ 0x00 ]   // AcknowledgeFlags: SessionPresentFlag=0 
[ 0x00 ]   // ReturnCode={0:成功} 

```

## 三. PUBLISH – 发布消息

### 3.1 报文格式

0x30 0x10 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 0x4C 0x45 0x4E 0x5F 0x4F 0x4E 

``` 
FixHeader{
PacketTag = 48
PacketType  = 3
RemainLength  = 16
}
VariableHeaderPublish{
topic_name_len_= 8
topic_name= message1
             0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31
}
PayloadPublish{
payload_= 0x4C 0x45 0x4E 0x5F 0x4F 0x4E 
            L   E   D       _   O   N
}
```
## 四. PUBACK – 发布确认




## 八. SUBSCRIBE - 订阅主题

### 8.1 报文格式

0x82 0x0D 0x00 0x02 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 0x00

``` 
FixHeader{
PacketTag = 130
PacketType  = 8
RemainLength  = 13
}
VariableHeaderSubscribe{
packet_identifier_= 2
}
PayloadSubscribe{
TopicFilters= 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 0x00 
}

MQTT:0x82 0x0D 0x00 0x02 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 0x00 

Send One Packet Succ:

```

## 九. SUBACK – 订阅确认

### 9.1 报文格式

0x90 0x03 0x00 0x02 0x00 

```
FixHeader{
PacketTag = 144
PacketType  = 9
RemainLength  = 3
}
VariableHeaderSubscribeAck{
packet_identifier_= 2
}
PayloadSubscribeAck{
Results= 0x00 
}

 Publish SubTopicAck:0x90 0x03 0x00 0x02 0x00 

```


## 十. UNSUBACK – 取消订阅确认

0xA2 0x0C 0x00 0x01 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 

``` 
FixHeader{
PacketTag = 162
PacketType  = 10
RemainLength  = 12
}
VariableHeaderUnSubscribe{
packet_identifier_= 1
}
PayloadUnSubscribe{
UnSubTopicFilter= 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 
}

MQTT:0xA2 0x0C 0x00 0x01 0x00 0x08 0x6D 0x65 0x73 0x73 0x61 0x67 0x65 0x31 

Send One Packet Succ:
```

## 十一.  UNSUBACK – 取消订阅确认


0xB0 0x02 0x00 0x01

```
FixHeader{
PacketTag = 176
PacketType  = 11
RemainLength  = 2
}
VariableHeaderUnSubscribeAck{
packet_identifier_= 1
}
PayloadUnSubscribeAck{
Results= 
}

 Publish UnSubTopicAck:0xB0 0x02 0x00 0x01
```



0x01 0x00 0x3F 0x7B 0x22 0x64 0x61 0x74 0x61 0x73 0x74 0x72 0x65 0x61 0x6D 0x73 
0x22 0x3A 0x5B 0x7B 0x22 0x69 0x64 0x22 0x3A 0x22 0x6D 0x65 0x73 0x73 0x61 0x67 
0x65 0x31 0x22 0x2C 0x22 0x64 0x61 0x74 0x61 0x70 0x6F 0x69 0x6E 0x74 0x73 0x22 
0x3A 0x5B 0x7B 0x22 0x76 0x61 0x6C 0x75 0x65 0x22 0x3A 0x36 0x30 0x7D 0x5D 0x7D 
0x5D 0x7D 